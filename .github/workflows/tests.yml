name: Tests

on:
  push:
    branches:    
      - 'master'   # excludes master

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      # - name: Create network
      #   run: docker network create database
      - name: Build and run the docker compose stack
        run: docker-compose -f "docker-compose-test.yml" --env-file .env.test up -d
      - name: Perform unit tests
        run: docker exec fastapi python -m pytest -v -m unittest
      - name: Perform api tests
        run: docker exec fastapi python -m pytest -v -m apitest  
      - name: Initialize the test database used for the frontend tests
        run: | 
          docker exec fastapi aerich init -t app.db.TORTOISE_ORM
          docker exec fastapi aerich init-db
          docker exec fastapi aerich upgrade
          docker exec database psql -U postgres -d test -f setup_testdata.sql
      - name: Build frontend tests image
        run: docker build -t playwright-tests ./frontend-testing/.
      - name: Run frontend tests image
        run: docker run playwright-tests